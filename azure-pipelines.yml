trigger:
- master

pool:
  vmImage: 'windows-latest'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '3.x'

- script: |
    dotnet build --configuration Release
    dotnet publish --configuration Release --output $(Build.ArtifactStagingDirectory)/publish
  displayName: 'Build and Publish'
  workingDirectory: $(Build.SourcesDirectory)

- task: PublishBuildArtifacts@1
  inputs:
    pathtoPublish: '$(Build.ArtifactStagingDirectory)/publish'
    artifactName: 'drop'

- task: AWSCLI@1
  inputs:
    awsCredentials: 'repo-to-s3' # You need to configure an AWS service connection in your project settings.
    awsRegion: 'us-east-1'
    command: 's3 sync'
    arguments: '$(Build.ArtifactStagingDirectory)/publish s3://cpsc4911team02generalbucket'
  displayName: 'Sync to S3'

- task: S3Upload@1
  inputs:
    awsCredentials: 'repo-to-s3'
    regionName: 'us-east-1'
    bucketName: 'cpsc4911team02generalbucket'
    sourceFolder: '$(Build.ArtifactStagingDirectory)/publish'
    targetFolder: 'F23-Team02'

- task: S3Download@1
  inputs:
    awsCredentials: 'repo-to-s3'
    regionName: 'us-east-1'
    bucketName: 'cpsc4911team02generalbucket'
    sourceFolder: 'F23-Team02'
    targetFolder: '$(Build.ArtifactStagingDirectory)/downloaded'
